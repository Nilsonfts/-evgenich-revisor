import logging
import os
import telebot
import datetime
import gspread
from oauth2client.service_account import ServiceAccountCredentials
from telebot import types

# Настройка логгера
logging.basicConfig(level=logging.INFO)

# Переменные окружения (для Railway или локально)
BOT_TOKEN = os.getenv("BOT_TOKEN")
SPREADSHEET_ID = os.getenv("SPREADSHEET_ID")

# Авторизация Google Sheets
scope = ["https://spreadsheets.google.com/feeds", "https://www.googleapis.com/auth/drive"]
creds = ServiceAccountCredentials.from_json_keyfile_name("credentials.json", scope)
client = gspread.authorize(creds)
sheet = client.open_by_key(SPREADSHEET_ID).sheet1

bot = telebot.TeleBot(BOT_TOKEN)

soviet_phrases = {
    "check_in": [
        "📻 На смене! Готов вещать в эфир, как по ГОСТу!",
        "🕰️ Прибыл, как трамвай по расписанию.",
        "🧰 Заступаю. Всё под контролем, как у диспетчера!",
        "💂‍♂️ В строю! Рапортую о прибытии.",
        "🛠️ Готов работать на благо эфира.",
        "📡 Приём! Ведущий на связи.",
        "📋 Работаю строго по регламенту.",
        "⚙️ Готов к труду и обороне!",
        "🎙️ У микрофона, можно начинать шоу!",
        "🔧 Инструмент при мне, голос при себе.",
        "📻 Радиоточка активирована.",
        "🕶️ Пунктуален, как никогда.",
        "🛎️ Готов к бою за чистоту эфира.",
        "🔌 Включён. Заряжен. Сосредоточен.",
        "🎛️ Все кнопки нажаты — поехали!",
        "🎚️ Техника работает, ведущий тоже.",
        "📞 На проводе. Звоните, пишите!",
        "📠 Докладываю: смена началась.",
        "📍Местонахождение подтверждено.",
        "📊 Вошёл в зону вещания."
    ],
    "voice_reminder": [
        "🔔 Товарищ, пора бы уже проговорить текст!",
        "📢 Эфир ждёт, микрофон скучает!",
        "🎙️ Без голоса — как без хлеба!",
        "⏰ Напомню нежно — текст в студию!",
        "📻 Молчание — не золото, а штраф!",
        "🔊 Время звучать, а не молчать!",
        "💬 Эй, ты там? Эфир пустует!",
        "📡 Передай слово в эфир!",
        "🎤 Где твой голос, ведущий?!",
        "🧭 Пора напомнить о себе эфирной волне.",
        "🗣️ Речь — твой рабочий инструмент!",
        "🛎️ Голос — это сигнал. Подай его!",
        "📞 Скажи хоть что-нибудь!",
        "🗯️ Не молчи — эфир тебя ждёт!",
        "🎧 Слушатели томятся!",
        "🔁 Не забудь отправить голос!",
        "🎼 Не звенит — значит, скучно!",
        "🚨 Срочно нужен текст ведущего!",
        "🔕 Молчание — враг плана!",
        "📯 Эй, ведущий, разбуди волну!"
    ],
    "break_warn": [
        "☕ Перерыв понятен, но не превращайся в самовар!",
        "📌 Уже 15 минут — пора возвращаться в бой!",
        "📯 Где ты там? Народ волнуется!",
        "🕵️‍♂️ Засиделся! Дисциплина прежде всего.",
        "🚨 Возвращайся, пока тебя не забыли!",
        "⏳ Перерыв — это 15 минут, не 15 дней!",
        "🛎️ Кофе остыл — в эфир пора!",
        "📉 Долгий отдых = снижение КПД.",
        "🎯 Фокус теряется! Возвращайся!",
        "📋 План не ждёт!",
        "💥 Перерыв — это не отпуск!",
        "🚦Включайся! Пора продолжать!",
        "🔁 Ротация закончена. Пора на пост!",
        "📶 Связь восстанавливай — эфир зовёт!",
        "🕘 Перерыв был. Теперь — труд!",
        "🔍 Командование зафиксировало отсутствие!",
        "🧭 Найден вне зоны покрытия — возвращайся!",
        "📡 Сигнал слабый. Возврат в эфир необходим!",
        "👁️ Контроль ослаб! Срочно на место!",
        "⚠️ Слишком тихо. Подозрительно..."
    ],
    "report": [
        "✅ Принято! Доклад блестящий!",
        "📈 Отчёт принят, как тост на банкете!",
        "🗂️ Всё внесено. Молодец!",
        "📋 Система довольна твоей дисциплиной.",
        "🧾 Зафиксировано в летописях рабочего дня.",
        "📊 Данные занесены. Профсоюз одобрит.",
        "🔍 В отчёте всё чётко. Хорошо поработал!",
        "✏️ Бумага стерпела — и таблица тоже.",
        "🕮 Зарегистрировано. Работа идёт!",
        "📎 Вклад отмечен. Ты надёжен, как токарь!",
        "📓 Отчёт выглядит достойно.",
        "📌 Принято и проверено. Всё по уставу!",
        "🔖 Лог обновлён. Товарищи довольны!",
        "📘 Архив пополнился свежей строкой.",
        "📚 Бумаги летают, отчёт готов!",
        "🔐 Дело сделано, запись сохранена!",
        "📨 Принято. Информация ушла в хронику!",
        "💼 Всё по регламенту. Спасибо!",
        "🖇️ Скреплено и заархивировано!",
        "📅 Ежедневный подвиг зафиксирован."
    ]
}

@bot.message_handler(commands=["start", "help"])
def send_welcome(message):
    bot.reply_to(message, "Салам, ведущий! Используй /отчет чтобы внести свой вклад в славную таблицу.")

@bot.message_handler(commands=["отчет"])
def handle_report(message):
    user = message.from_user
    username = f"@{user.username}" if user.username else user.first_name
    now = datetime.datetime.now().strftime("%d.%m.%Y")
    phrase = soviet_phrases["report"][hash(user.id) % len(soviet_phrases["report"])]

    # Заглушка чисел — по-хорошему, должны спрашиваться
    facts = "3"
    could_be = "5"

    row = [f"#{now}", username, facts, could_be, phrase]
    sheet.append_row(row)
    logging.info(f"Добавлен отчет: {row}")
    bot.reply_to(message, f"{phrase}\nЗаписано в журнал за {now}")

bot.polling()
