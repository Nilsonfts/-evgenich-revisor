import logging
import os
import telebot
import datetime
import gspread
from oauth2client.service_account import ServiceAccountCredentials
from telebot import types
import json
import pytz  # –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —á–∞—Å–æ–≤—ã–º–∏ –ø–æ—è—Å–∞–º–∏, –µ–µ –Ω—É–∂–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å

# --- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è ---
logging.basicConfig(level=logging.INFO)

BOT_TOKEN = os.getenv("BOT_TOKEN")
SPREADSHEET_ID = os.getenv("SPREADSHEET_ID")

scope = ["https://spreadsheets.google.com/feeds", "https://www.googleapis.com/auth/drive"]
creds_dict = json.loads(os.getenv("GOOGLE_APPLICATION_CREDENTIALS"))
creds = ServiceAccountCredentials.from_json_keyfile_dict(creds_dict, scope)
client = gspread.authorize(creds)
sheet = client.open_by_key(SPREADSHEET_ID).sheet1

bot = telebot.TeleBot(BOT_TOKEN)

# --- –í–ê–® –°–õ–û–í–ê–†–¨ –° –§–†–ê–ó–ê–ú–ò (–¢–ï–ü–ï–†–¨ –ü–û–õ–ù–û–°–¢–¨–Æ) ---
soviet_phrases = {
    "check_in": [
        "üìª –ù–∞ —Å–º–µ–Ω–µ! –ì–æ—Ç–æ–≤ –≤–µ—â–∞—Ç—å –≤ —ç—Ñ–∏—Ä, –∫–∞–∫ –ø–æ –ì–û–°–¢—É!",
        "üï∞Ô∏è –ü—Ä–∏–±—ã–ª, –∫–∞–∫ —Ç—Ä–∞–º–≤–∞–π –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é.",
        "üß∞ –ó–∞—Å—Ç—É–ø–∞—é. –í—Å—ë –ø–æ–¥ –∫–æ–Ω—Ç—Ä–æ–ª–µ–º, –∫–∞–∫ —É –¥–∏—Å–ø–µ—Ç—á–µ—Ä–∞!",
        "üíÇ‚Äç‚ôÇÔ∏è –í —Å—Ç—Ä–æ—é! –†–∞–ø–æ—Ä—Ç—É—é –æ –ø—Ä–∏–±—ã—Ç–∏–∏.",
        "üõ†Ô∏è –ì–æ—Ç–æ–≤ —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–∞ –±–ª–∞–≥–æ —ç—Ñ–∏—Ä–∞.",
        "üì° –ü—Ä–∏—ë–º! –í–µ–¥—É—â–∏–π –Ω–∞ —Å–≤—è–∑–∏.",
        "üìã –†–∞–±–æ—Ç–∞—é —Å—Ç—Ä–æ–≥–æ –ø–æ —Ä–µ–≥–ª–∞–º–µ–Ω—Ç—É.",
        "‚öôÔ∏è –ì–æ—Ç–æ–≤ –∫ —Ç—Ä—É–¥—É –∏ –æ–±–æ—Ä–æ–Ω–µ!",
        "üéôÔ∏è –£ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞, –º–æ–∂–Ω–æ –Ω–∞—á–∏–Ω–∞—Ç—å —à–æ—É!",
        "üîß –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –ø—Ä–∏ –º–Ω–µ, –≥–æ–ª–æ—Å –ø—Ä–∏ —Å–µ–±–µ.",
        "üìª –†–∞–¥–∏–æ—Ç–æ—á–∫–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞.",
        "üï∂Ô∏è –ü—É–Ω–∫—Ç—É–∞–ª–µ–Ω, –∫–∞–∫ –Ω–∏–∫–æ–≥–¥–∞.",
        "üõéÔ∏è –ì–æ—Ç–æ–≤ –∫ –±–æ—é –∑–∞ —á–∏—Å—Ç–æ—Ç—É —ç—Ñ–∏—Ä–∞.",
        "üîå –í–∫–ª—é—á—ë–Ω. –ó–∞—Ä—è–∂–µ–Ω. –°–æ—Å—Ä–µ–¥–æ—Ç–æ—á–µ–Ω.",
        "üéõÔ∏è –í—Å–µ –∫–Ω–æ–ø–∫–∏ –Ω–∞–∂–∞—Ç—ã ‚Äî –ø–æ–µ—Ö–∞–ª–∏!",
        "üéöÔ∏è –¢–µ—Ö–Ω–∏–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç, –≤–µ–¥—É—â–∏–π —Ç–æ–∂–µ.",
        "üìû –ù–∞ –ø—Ä–æ–≤–æ–¥–µ. –ó–≤–æ–Ω–∏—Ç–µ, –ø–∏—à–∏—Ç–µ!",
        "üì† –î–æ–∫–ª–∞–¥—ã–≤–∞—é: —Å–º–µ–Ω–∞ –Ω–∞—á–∞–ª–∞—Å—å.",
        "üìç–ú–µ—Å—Ç–æ–Ω–∞—Ö–æ–∂–¥–µ–Ω–∏–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ.",
        "üìä –í–æ—à—ë–ª –≤ –∑–æ–Ω—É –≤–µ—â–∞–Ω–∏—è."
    ],
    "voice_reminder": [
        "üîî –¢–æ–≤–∞—Ä–∏—â, –ø–æ—Ä–∞ –±—ã —É–∂–µ –ø—Ä–æ–≥–æ–≤–æ—Ä–∏—Ç—å —Ç–µ–∫—Å—Ç!",
        "üì¢ –≠—Ñ–∏—Ä –∂–¥—ë—Ç, –º–∏–∫—Ä–æ—Ñ–æ–Ω —Å–∫—É—á–∞–µ—Ç!",
        "üéôÔ∏è –ë–µ–∑ –≥–æ–ª–æ—Å–∞ ‚Äî –∫–∞–∫ –±–µ–∑ —Ö–ª–µ–±–∞!",
        "‚è∞ –ù–∞–ø–æ–º–Ω—é –Ω–µ–∂–Ω–æ ‚Äî —Ç–µ–∫—Å—Ç –≤ —Å—Ç—É–¥–∏—é!",
        "üìª –ú–æ–ª—á–∞–Ω–∏–µ ‚Äî –Ω–µ –∑–æ–ª–æ—Ç–æ, –∞ —à—Ç—Ä–∞—Ñ!",
        "üîä –í—Ä–µ–º—è –∑–≤—É—á–∞—Ç—å, –∞ –Ω–µ –º–æ–ª—á–∞—Ç—å!",
        "üí¨ –≠–π, —Ç—ã —Ç–∞–º? –≠—Ñ–∏—Ä –ø—É—Å—Ç—É–µ—Ç!",
        "üì° –ü–µ—Ä–µ–¥–∞–π —Å–ª–æ–≤–æ –≤ —ç—Ñ–∏—Ä!",
        "üé§ –ì–¥–µ —Ç–≤–æ–π –≥–æ–ª–æ—Å, –≤–µ–¥—É—â–∏–π?!",
        "üß≠ –ü–æ—Ä–∞ –Ω–∞–ø–æ–º–Ω–∏—Ç—å –æ —Å–µ–±–µ —ç—Ñ–∏—Ä–Ω–æ–π –≤–æ–ª–Ω–µ.",
        "üó£Ô∏è –†–µ—á—å ‚Äî —Ç–≤–æ–π —Ä–∞–±–æ—á–∏–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç!",
        "üõéÔ∏è –ì–æ–ª–æ—Å ‚Äî —ç—Ç–æ —Å–∏–≥–Ω–∞–ª. –ü–æ–¥–∞–π –µ–≥–æ!",
        "üìû –°–∫–∞–∂–∏ —Ö–æ—Ç—å —á—Ç–æ-–Ω–∏–±—É–¥—å!",
        "üóØÔ∏è –ù–µ –º–æ–ª—á–∏ ‚Äî —ç—Ñ–∏—Ä —Ç–µ–±—è –∂–¥—ë—Ç!",
        "üéß –°–ª—É—à–∞—Ç–µ–ª–∏ —Ç–æ–º—è—Ç—Å—è!",
        "üîÅ –ù–µ –∑–∞–±—É–¥—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≥–æ–ª–æ—Å!",
        "üéº –ù–µ –∑–≤–µ–Ω–∏—Ç ‚Äî –∑–Ω–∞—á–∏—Ç, —Å–∫—É—á–Ω–æ!",
        "üö® –°—Ä–æ—á–Ω–æ –Ω—É–∂–µ–Ω —Ç–µ–∫—Å—Ç –≤–µ–¥—É—â–µ–≥–æ!",
        "üîï –ú–æ–ª—á–∞–Ω–∏–µ ‚Äî –≤—Ä–∞–≥ –ø–ª–∞–Ω–∞!",
        "üìØ –≠–π, –≤–µ–¥—É—â–∏–π, —Ä–∞–∑–±—É–¥–∏ –≤–æ–ª–Ω—É!"
    ],
    "break_warn": [
        "‚òï –ü–µ—Ä–µ—Ä—ã–≤ –ø–æ–Ω—è—Ç–µ–Ω, –Ω–æ –Ω–µ –ø—Ä–µ–≤—Ä–∞—â–∞–π—Å—è –≤ —Å–∞–º–æ–≤–∞—Ä!",
        "üìå –£–∂–µ 15 –º–∏–Ω—É—Ç ‚Äî –ø–æ—Ä–∞ –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å—Å—è –≤ –±–æ–π!",
        "üìØ –ì–¥–µ —Ç—ã —Ç–∞–º? –ù–∞—Ä–æ–¥ –≤–æ–ª–Ω—É–µ—Ç—Å—è!",
        "üïµÔ∏è‚Äç‚ôÇÔ∏è –ó–∞—Å–∏–¥–µ–ª—Å—è! –î–∏—Å—Ü–∏–ø–ª–∏–Ω–∞ –ø—Ä–µ–∂–¥–µ –≤—Å–µ–≥–æ.",
        "üö® –í–æ–∑–≤—Ä–∞—â–∞–π—Å—è, –ø–æ–∫–∞ —Ç–µ–±—è –Ω–µ –∑–∞–±—ã–ª–∏!",
        "‚è≥ –ü–µ—Ä–µ—Ä—ã–≤ ‚Äî —ç—Ç–æ 15 –º–∏–Ω—É—Ç, –Ω–µ 15 –¥–Ω–µ–π!",
        "üõéÔ∏è –ö–æ—Ñ–µ –æ—Å—Ç—ã–ª ‚Äî –≤ —ç—Ñ–∏—Ä –ø–æ—Ä–∞!",
        "üìâ –î–æ–ª–≥–∏–π –æ—Ç–¥—ã—Ö = —Å–Ω–∏–∂–µ–Ω–∏–µ –ö–ü–î.",
        "üéØ –§–æ–∫—É—Å —Ç–µ—Ä—è–µ—Ç—Å—è! –í–æ–∑–≤—Ä–∞—â–∞–π—Å—è!",
        "üìã –ü–ª–∞–Ω –Ω–µ –∂–¥—ë—Ç!",
        "üí• –ü–µ—Ä–µ—Ä—ã–≤ ‚Äî —ç—Ç–æ –Ω–µ –æ—Ç–ø—É—Å–∫!",
        "üö¶–í–∫–ª—é—á–∞–π—Å—è! –ü–æ—Ä–∞ –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å!",
        "üîÅ –†–æ—Ç–∞—Ü–∏—è –∑–∞–∫–æ–Ω—á–µ–Ω–∞. –ü–æ—Ä–∞ –Ω–∞ –ø–æ—Å—Ç!",
        "üì∂ –°–≤—è–∑—å –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–π ‚Äî —ç—Ñ–∏—Ä –∑–æ–≤—ë—Ç!",
        "üïò –ü–µ—Ä–µ—Ä—ã–≤ –±—ã–ª. –¢–µ–ø–µ—Ä—å ‚Äî —Ç—Ä—É–¥!",
        "üîç –ö–æ–º–∞–Ω–¥–æ–≤–∞–Ω–∏–µ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–ª–æ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ!",
        "üß≠ –ù–∞–π–¥–µ–Ω –≤–Ω–µ –∑–æ–Ω—ã –ø–æ–∫—Ä—ã—Ç–∏—è ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–π—Å—è!",
        "üì° –°–∏–≥–Ω–∞–ª —Å–ª–∞–±—ã–π. –í–æ–∑–≤—Ä–∞—Ç –≤ —ç—Ñ–∏—Ä –Ω–µ–æ–±—Ö–æ–¥–∏–º!",
        "üëÅÔ∏è –ö–æ–Ω—Ç—Ä–æ–ª—å –æ—Å–ª–∞–±! –°—Ä–æ—á–Ω–æ –Ω–∞ –º–µ—Å—Ç–æ!",
        "‚ö†Ô∏è –°–ª–∏—à–∫–æ–º —Ç–∏—Ö–æ. –ü–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ..."
    ],
    "report": [
        "‚úÖ –ü—Ä–∏–Ω—è—Ç–æ! –î–æ–∫–ª–∞–¥ –±–ª–µ—Å—Ç—è—â–∏–π!",
        "üìà –û—Ç—á—ë—Ç –ø—Ä–∏–Ω—è—Ç, –∫–∞–∫ —Ç–æ—Å—Ç –Ω–∞ –±–∞–Ω–∫–µ—Ç–µ!",
        "üóÇÔ∏è –í—Å—ë –≤–Ω–µ—Å–µ–Ω–æ. –ú–æ–ª–æ–¥–µ—Ü!",
        "üìã –°–∏—Å—Ç–µ–º–∞ –¥–æ–≤–æ–ª—å–Ω–∞ —Ç–≤–æ–µ–π –¥–∏—Å—Ü–∏–ø–ª–∏–Ω–æ–π.",
        "üßæ –ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–æ –≤ –ª–µ—Ç–æ–ø–∏—Å—è—Ö —Ä–∞–±–æ—á–µ–≥–æ –¥–Ω—è.",
        "üìä –î–∞–Ω–Ω—ã–µ –∑–∞–Ω–µ—Å–µ–Ω—ã. –ü—Ä–æ—Ñ—Å–æ—é–∑ –æ–¥–æ–±—Ä–∏—Ç.",
        "üîç –í –æ—Ç—á—ë—Ç–µ –≤—Å—ë —á—ë—Ç–∫–æ. –•–æ—Ä–æ—à–æ –ø–æ—Ä–∞–±–æ—Ç–∞–ª!",
        "‚úèÔ∏è –ë—É–º–∞–≥–∞ —Å—Ç–µ—Ä–ø–µ–ª–∞ ‚Äî –∏ —Ç–∞–±–ª–∏—Ü–∞ —Ç–æ–∂–µ.",
        "üïÆ –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–æ. –†–∞–±–æ—Ç–∞ –∏–¥—ë—Ç!",
        "üìé –í–∫–ª–∞–¥ –æ—Ç–º–µ—á–µ–Ω. –¢—ã –Ω–∞–¥—ë–∂–µ–Ω, –∫–∞–∫ —Ç–æ–∫–∞—Ä—å!",
        "üìì –û—Ç—á—ë—Ç –≤—ã–≥–ª—è–¥–∏—Ç –¥–æ—Å—Ç–æ–π–Ω–æ.",
        "üìå –ü—Ä–∏–Ω—è—Ç–æ –∏ –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ. –í—Å—ë –ø–æ —É—Å—Ç–∞–≤—É!",
        "üîñ –õ–æ–≥ –æ–±–Ω–æ–≤–ª—ë–Ω. –¢–æ–≤–∞—Ä–∏—â–∏ –¥–æ–≤–æ–ª—å–Ω—ã!",
        "üìò –ê—Ä—Ö–∏–≤ –ø–æ–ø–æ–ª–Ω–∏–ª—Å—è —Å–≤–µ–∂–µ–π —Å—Ç—Ä–æ–∫–æ–π.",
        "üìö –ë—É–º–∞–≥–∏ –ª–µ—Ç–∞—é—Ç, –æ—Ç—á—ë—Ç –≥–æ—Ç–æ–≤!",
        "üîê –î–µ–ª–æ —Å–¥–µ–ª–∞–Ω–æ, –∑–∞–ø–∏—Å—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!",
        "üì® –ü—Ä–∏–Ω—è—Ç–æ. –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è —É—à–ª–∞ –≤ —Ö—Ä–æ–Ω–∏–∫—É!",
        "üíº –í—Å—ë –ø–æ —Ä–µ–≥–ª–∞–º–µ–Ω—Ç—É. –°–ø–∞—Å–∏–±–æ!",
        "üñáÔ∏è –°–∫—Ä–µ–ø–ª–µ–Ω–æ –∏ –∑–∞–∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–æ!",
        "üìÖ –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –ø–æ–¥–≤–∏–≥ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω."
    ]
}

# --- –•—Ä–∞–Ω–∏–ª–∏—â–µ –¥–ª—è –ø–æ–¥—Å—á–µ—Ç–∞ –≥–æ–ª–æ—Å–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π ---
voice_counts = {}

# --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–¥—Å—á–µ—Ç–∞ –≥–æ–ª–æ—Å–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π ---
@bot.message_handler(content_types=['voice'])
def handle_voice_message(message):
    user_id = message.from_user.id
    username = f"@{message.from_user.username}" if message.from_user.username else message.from_user.first_name
    current_count = voice_counts.get(user_id, 0) + 1
    voice_counts[user_id] = current_count
    logging.info(f"–ó–∞—Å—á–∏—Ç–∞–Ω–æ –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç {username}. –¢–µ–∫—É—â–∏–π —Å—á–µ—Ç: {current_count}")

# --- –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –±–æ—Ç–∞ ---
@bot.message_handler(commands=["start", "help"])
def send_welcome(message):
    bot.reply_to(message, "–°–∞–ª–∞–º, –≤–µ–¥—É—â–∏–π! –Ø –±—É–¥—É –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å—á–∏—Ç–∞—Ç—å —Ç–≤–æ–∏ –≥–æ–ª–æ—Å–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è. –ö–æ–≥–¥–∞ –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è, –∏—Å–ø–æ–ª—å–∑—É–π –∫–æ–º–∞–Ω–¥—É /–æ—Ç—á–µ—Ç.")

@bot.message_handler(commands=["–æ—Ç—á–µ—Ç"])
def handle_report(message):
    try:
        user_id = message.from_user.id
        user = message.from_user
        username = f"@{user.username}" if user.username else user.first_name
        facts = voice_counts.get(user_id, 0)
        could_be = ""  # –û—Å—Ç–∞–≤–ª—è–µ–º —ç—Ç–æ –ø–æ–ª–µ –ø—É—Å—Ç—ã–º, –∫–∞–∫ –∏ –¥–æ–≥–æ–≤–∞—Ä–∏–≤–∞–ª–∏—Å—å
        moscow_tz = pytz.timezone("Europe/Moscow")
        now = datetime.datetime.now(moscow_tz).strftime("%d.%m.%Y")
        phrase = soviet_phrases["report"][hash(user_id) % len(soviet_phrases["report"])]
        row = [f"#{now}", username, str(facts), could_be, phrase]
        sheet.append_row(row)
        logging.info(f"–î–æ–±–∞–≤–ª–µ–Ω –æ—Ç—á–µ—Ç: {row}")
        bot.reply_to(message, f"{phrase}\n–ó–∞–ø–∏—Å–∞–Ω–æ –≤ –∂—É—Ä–Ω–∞–ª **{facts}** –≥–æ–ª–æ—Å–æ–≤—ã—Ö –∑–∞ {now}.")
        voice_counts[user_id] = 0
        logging.info(f"–°—á–µ—Ç—á–∏–∫ –¥–ª—è {username} —Å–±—Ä–æ—à–µ–Ω.")
    except Exception as e:
        logging.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –æ—Ç—á–µ—Ç–∞: {e}")
        bot.reply_to(message, "–¢–æ–≤–∞—Ä–∏—â, –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –æ—Ç—á–µ—Ç–∞ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –Ω–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞!")

# --- –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞ ---
if __name__ == '__main__':
    logging.info("–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω...")
    bot.polling(none_stop=True)
