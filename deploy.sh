#!/bin/bash
# deploy.sh - –°–∫—Ä–∏–ø—Ç —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è –∫–∞—Ä–∞–æ–∫–µ-—Ä–µ–≤–∏–∑–æ—Ä –±–æ—Ç–∞

echo "üöÄ –†–ê–ó–í–ï–†–¢–´–í–ê–ù–ò–ï –ö–ê–†–ê–û–ö–ï-–†–ï–í–ò–ó–û–† –ë–û–¢–ê"
echo "======================================"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º Python
if ! command -v python3 &> /dev/null; then
    echo "‚ùå Python3 –Ω–µ –Ω–∞–π–¥–µ–Ω. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Python 3.8+"
    exit 1
fi

echo "‚úÖ Python –Ω–∞–π–¥–µ–Ω: $(python3 --version)"

# –°–æ–∑–¥–∞–µ–º –ø–∞–ø–∫—É –¥–ª—è –¥–∞–Ω–Ω—ã—Ö
mkdir -p data
echo "‚úÖ –ü–∞–ø–∫–∞ data —Å–æ–∑–¥–∞–Ω–∞"

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
pip3 install -r requirements.txt

if [ $? -eq 0 ]; then
    echo "‚úÖ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
else
    echo "‚ùå –û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
if [ ! -f "config.py" ]; then
    echo "‚ùå –§–∞–π–ª config.py –Ω–µ –Ω–∞–π–¥–µ–Ω"
    echo "üí° –°–æ–∑–¥–∞–π—Ç–µ config.py –Ω–∞ –æ—Å–Ω–æ–≤–µ config.py.example"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º BOT_TOKEN –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
if ! grep -q "BOT_TOKEN.*=" config.py; then
    echo "‚ö†Ô∏è  –í–Ω–∏–º–∞–Ω–∏–µ: BOT_TOKEN –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –≤ config.py"
    echo "üí° –î–æ–±–∞–≤—å—Ç–µ –≤–∞—à BOT_TOKEN –≤ config.py"
fi

echo "‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–µ–Ω–∞"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–º–ø–∏–ª—è—Ü–∏—é
echo "üîß –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞..."
python3 -m py_compile *.py handlers/*.py

if [ $? -eq 0 ]; then
    echo "‚úÖ –ö–æ–¥ —Å–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω –±–µ–∑ –æ—à–∏–±–æ–∫"
else
    echo "‚ùå –û—à–∏–±–∫–∏ –≤ –∫–æ–¥–µ"
    exit 1
fi

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
echo "üíæ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö..."
python3 -c "from database import db; print('‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞')"

# –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞
echo ""
echo "üé§ –ö–ê–†–ê–û–ö–ï-–†–ï–í–ò–ó–û–† –ì–û–¢–û–í –ö –ó–ê–ü–£–°–ö–£!"
echo "======================================"
echo ""
echo "üé≠ –ù–æ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:"
echo "   ‚Ä¢ –ú–Ω–æ–≥–æ—Ä–æ–ª–µ–≤—ã–µ —Å–º–µ–Ω—ã (–∫–∞—Ä–∞–æ–∫–µ + –ú–° –≤ –ü–¢-–°–ë)"
echo "   ‚Ä¢ –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å (/admin)"
echo "   ‚Ä¢ SQLite –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏"
echo "   ‚Ä¢ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–∏—Å—Ç–µ–º–∞ —Ä–æ–ª–µ–π"
echo ""
echo "üöÄ –î–ª—è –∑–∞–ø—É—Å–∫–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:"
echo "   python3 main.py"
echo ""
echo "üìö –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:"
echo "   /start - –Ω–∞—á–∞—Ç—å —Å–º–µ–Ω—É (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ —Ä–æ–ª–∏)"
echo "   /admin - –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤)"
echo "   /help  - –ø–æ–¥—Ä–æ–±–Ω–∞—è —Å–ø—Ä–∞–≤–∫–∞"
echo ""

# –ü—Ä–µ–¥–ª–∞–≥–∞–µ–º –∑–∞–ø—É—Å–∫
read -p "üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞ —Å–µ–π—á–∞—Å? (y/N): " -r
if [[ $REPLY =~ ^[Yy]$ ]]; then
    echo "üé§ –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞..."
    python3 main.py
fi
